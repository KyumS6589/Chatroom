<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatroom</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    form { margin: 10px 0; }
    input, button { padding: 8px; margin: 4px; }
    #messages { background: #fff; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
    .msg { padding: 4px; border-bottom: 1px solid #eee; }
  </style>
  <script src="index.js"></script>
</head>
<body>
  <div id="app">
    <h1>Chatroom</h1>

    <div id="auth">
      <h2>Signup / Login</h2>
      <form id="signupForm">
        <input id="signupUser" placeholder="Username" required />
        <input id="signupPass" type="password" placeholder="Password" required />
        <button type="submit">Signup</button>
      </form>
      <form id="loginForm">
        <input id="loginUser" placeholder="Username" required />
        <input id="loginPass" type="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
    </div>

    <div id="chat" style="display:none;">
      <h2>Rooms</h2>
      <form id="roomForm">
        <input id="roomName" placeholder="Room name" required />
        <button type="submit">Create Room</button>
      </form>
      <select id="roomList"></select>
      <button id="joinBtn">Join</button>

      <h2>Messages</h2>
      <div id="messages"></div>
      <form id="msgForm">
        <input id="msgInput" placeholder="Type a message..." required />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script>
    const API = 'http://localhost:4000/api';
    let token = null;
    let currentRoom = null;

    function saveToken(t){ token=t; localStorage.setItem('token',t); }
    function loadToken(){
      token=localStorage.getItem('token');
      if(token){
        document.getElementById('auth').style.display='none';
        document.getElementById('chat').style.display='block';
        loadRooms();
      }
    }

    async function signup(username,password){
      const res = await fetch(API+'/auth/signup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
      return res.json();
    }
    async function login(username,password){
      const res = await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
      return res.json();
    }
    async function loadRooms(){
      const res = await fetch(API+'/rooms',{headers:{Authorization:'Bearer '+token}});
      const data = await res.json();
      const sel = document.getElementById('roomList');
      sel.innerHTML = '';
      data.rooms.forEach(r=>{
        const opt=document.createElement('option');
        opt.value=r.id; opt.textContent=r.name; sel.appendChild(opt);
      });
    }
    async function createRoom(name){
      const res = await fetch(API+'/rooms',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({name})});
      return res.json();
    }
    async function joinRoom(id){
      await fetch(`${API}/rooms/${id}/join`,{method:'POST',headers:{Authorization:'Bearer '+token}});
      currentRoom=id; loadMessages();
    }
    async function sendMessage(content){
      await fetch(`${API}/rooms/${currentRoom}/messages`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({content})});
      loadMessages();
    }
    async function loadMessages(){
      if(!currentRoom) return;
      const res=await fetch(`${API}/rooms/${currentRoom}/messages?limit=50`,{headers:{Authorization:'Bearer '+token}});
      const data=await res.json();
      const box=document.getElementById('messages');
      box.innerHTML='';
      data.messages.reverse().forEach(m=>{
        const div=document.createElement('div');
        div.className='msg';
        div.textContent=`${m.username}: ${m.content}`;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
    }

    document.getElementById('signupForm').onsubmit=async e=>{
      e.preventDefault();
      const u=document.getElementById('signupUser').value;
      const p=document.getElementById('signupPass').value;
      const res=await signup(u,p);
      if(res.token){ saveToken(res.token); location.reload(); }
      else alert(res.error);
    };

    document.getElementById('loginForm').onsubmit=async e=>{
      e.preventDefault();
      const u=document.getElementById('loginUser').value;
      const p=document.getElementById('loginPass').value;
      const res=await login(u,p);
      if(res.token){ saveToken(res.token); location.reload(); }
      else alert(res.error);
    };

    document.getElementById('roomForm').onsubmit=async e=>{
      e.preventDefault();
      const name=document.getElementById('roomName').value;
      await createRoom(name);
      loadRooms();
    };

    document.getElementById('joinBtn').onclick=()=>{
      const id=document.getElementById('roomList').value;
      joinRoom(id);
    };

    document.getElementById('msgForm').onsubmit=async e=>{
      e.preventDefault();
      const msg=document.getElementById('msgInput').value;
      document.getElementById('msgInput').value='';
      await sendMessage(msg);
    };

    setInterval(loadMessages,3000);
    loadToken();
  </script>
</body>
</html>
